Настройка окружения
===================

Замена жёсткого диска на MacBook Air
------------------------------------

Для установки SSD-накопителя потребовался переходник с ``M`` ключом для NVM Express.
Накопитель с ключом ``B & M`` физически тоже подходит, но устройство с SATA 3 не было распознано.
При работе с ``Samsung 970 PRO NVMe`` были найдены проблемы во время установки Windows 10.
``WD Blue SN550`` работает без ошибок.

Установка нескольких операционных систем на MacBook Air
-------------------------------------------------------

macOS
~~~~~

* Сначала необходимо скачать пакет с macOS любым известным способом или с помощью ``About This Mac -> Software Update...`` пункта меню macOS.
* После получения пакета он будет находится в каталоге ``Applications``, в противном случае необходимо скопировать его туда.
* Далее с помощью команды ``sudo /Applications/Install\ macOS\ Big\ Sur.app/Contents/Resources/createinstallmedia --volume /Volumes/MyVolume`` создаётся загрузочный накопитель.
* Этот накопитель также может использоваться как набор утилит вместо режима восстановления ``Cmd + R`` (при этом во время появления окна установщика желательно успеть отключить интернет-соединение, чтобы ускорить процесс).
* Чтобы начать установку ``macOS`` необходимо нажать ``Alt`` во время загрузки.
* При настройке разделов желательно сразу указать APFS (GUID Partition Map) нужного размера (встроенное средство не позволяет удалить имеющийся контейнер APFS, поэтому лучше заранее использовать подходящий инструмент).

Windows 10
~~~~~~~~~~

* Когда ``macOS`` будет установлена, то потребуется создать загрузочный накопитель уже для ``Windows 10`` с помощью утилиты ``Boot Camp`` (только создать и скачать драйверы).
* Перезагрузить с нажатой кнопкой ``Alt`` и запустить установку.
* Во время разметки диска удалить пустой раздел, созданный при установке ``macOS``, и создать новый требуемого размера с учётом 16 MB для ``MSR (Reserved)`` и ~4 MB для округления в проводнике.
* После установки операционной системы будет запущен установщик драйверов ``Boot Camp``, если размер окна будет неправильным, то можно попробовать закрыть окно и ответить ``Нет``.
* Из-за некоторых проблем открыть панель управления ``Boot Camp`` будет возможно только из командной строки под администратором ``runas /trustlevel:0x20000 AppleControlPanel.exe``.
* Далее можно добавить необходимые разделы ``NTFS``.

Ubuntu
~~~~~~

* Загрузочный накопитель можно создать с помощью утилиты ``Rufus``, указав образ с операционной системой.
* ВНИМАНИЕ! При установке ``Ubuntu`` главное вручную сделать настройку разделов и установить загрузчик в раздел ``EFI`` (например /dev/nvme0n1p1), чтобы он добавился к имеющейся коллекции, а не заменил!
* После установки таблица разделов будет заменена на гибридную, и ``Windows`` перестанет запускаться в режиме ``EFI``, будет пытаться в ``BIOS`` и завершаться с ошибкой ``0xd000000e``.
* Для исправления загрузки потребуется ввести команды:

  * Запустить ``gdisk`` для нужного устройства ``gdisk /dev/nvme0n1`` (можно посмотреть в списке устройств).
  * Удостовериться, что устройство содержит нужные разделы ``p``, если нет, то выйти ``q``.
  * Перейти в экспертный режим ``x``.
  * Создать пустую запись MBR ``n``.
  * Сохранить изменения ``w``.
  * Перезагрузить компьютер ``reboot``.

rEFInd
~~~~~~

* Перед установкой загрузчика необходимо отключить защиту, перезагрузившись в режиме установки (или с комбинацией ``Cmd + R`` в режиме восстановления) командой ``csrutil disable``.
* Желательно скопировать каталог ``refind`` в место, где будет доступ из терминала установщика macOS, загрузиться с установочного носителя.
* Перейти в скопированный каталог и выполнить команду ``./refind-install`` для начала установки.
* Можно установить тему для загрузчика, скопировав каталог с ней в ``EFI/refind/`` и добавив к конфигурации ``refind.conf`` соответствующую настройку из ``README`` файла темы.
* Для настройки пунктов загрузчика есть несколько полезных параметров:

  * Отключение лишних пунктов загрузки Linux ``scan_all_linux_kernels false``.
  * Отключение старых загрузчиков ``scanfor internal, external, optical, manual``.
  * Отключение сканирования разделов ``dont_scan_volumes "OSX"``.
  * Поддержка виртуализации для Intel платформ ``enable_and_lock_vmx true``.
  * Чтобы скрыть ``Fallback`` пункт, необходимо переименовать файл ``EFI/Boot/bootx64.efi`` в ``EFI/Boot/bootx64.efi.hide``.

nobootsound
~~~~~~~~~~~

Дополнительно есть возможность заглушить звук при включении ноутбука ``https://github.com/matteoacrossi/nobootsound``.
